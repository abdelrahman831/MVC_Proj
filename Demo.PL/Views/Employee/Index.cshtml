@model IEnumerable<EmployeeToReturnDto>
@inject IDepartmentService departmentService
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Employees";
    var Departments = new SelectList(await departmentService.GetAllDepartmentsAsync(), nameof(DepartmentToReturnDto.Id), nameof(DepartmentToReturnDto.Name));
}

@if (!string.IsNullOrEmpty(TempData["Message"] as string))
{
    <div aria-live="polite" aria-atomic="true" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050;">
        <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <img src="~/img/checkmark.png" class="rounded me-2" alt="Success Icon" width="20" height="20">
                <strong class="me-auto text-primary">Success!</strong>
                <small class="text-muted">@DateTime.Now.ToString("hh:mm tt")</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                @TempData["Message"]
            </div>
        </div>
    </div>
}

<div class="container mt-4">
    <main role="main" class="pb-3">

        <h1 class="my-4 w-50 mx-auto text-center fw-bold border-bottom pb-3">All Employees</h1>

        <div class="container mt-4">
            <form class="row justify-content-center align-items-center">
                <div class="col-md-6">
                    <div class="input-group shadow rounded-pill">
                        <input class="form-control border-0 rounded-pill px-3"
                               type="text"
                               id="searchInput"
                               placeholder="🔍 Search By Employee..."
                               aria-label="Search"
                               style="height: 50px; font-size: 1.1rem;" />
                    </div>
                </div>
            </form>
        </div>


              
        </div>

        <div class="d-flex justify-content-center mt-4">
            <a class="btn btn-lg text-white px-4" style="background: linear-gradient(to right, #5c6bc0, #283593);"
               asp-controller="Employee" asp-action="Create">
                <i class="bi bi-person-plus-fill"></i> Create New Employee
            </a>
        </div>

        @if (Model.Any())
        {
            <div class="table-responsive mt-3">
                <table class="table table-striped table-hover text-center align-middle shadow-sm rounded">
                    <thead class="table-dark">
                        <tr>
                            <th>Photo</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Type</th>
                            <th>Age</th>
                            <th>Salary</th>
                            <th>Department</th>
                            <th>Active</th>
                            <th>Gender</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var employee in Model)
                        {
                            <tr>
                                <td>
                                    <img src="~/Files/Images/@(employee.ImagePath ?? "NotFound.png")" class="rounded-circle" width="40" height="40" />
                                </td>
                                <td>@employee.Name</td>
                                <td>@employee.Email</td>
                                <td>@employee.EmployeeType</td>
                                <td>@employee.Age</td>
                                <td>@employee.Salary</td>
                                <td>@(Departments.FirstOrDefault(d => d.Value == employee.DepartmentId.ToString())?.Text ?? "No Department")</td>
                                <td>
                                    <span class="badge @(employee.IsActive ? "bg-success" : "bg-danger")">
                                        @(employee.IsActive ? "Yes" : "No")
                                    </span>
                                </td>
                                <td>@employee.Gender</td>
                        <partial name="_ButtonsPartial" model="@employee.Id" />
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="alert alert-info mt-3">
                <h1 class="text-center">No Employees Found!</h1>
            </div>
        }

    </main>
</div>

<!-- Modal for Deleting Employee -->
@foreach (var employee in Model)
{
    <div class="modal fade" id="deleteModal-@employee.Id" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this employee?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form method="post" asp-controller="Employee" asp-action="Delete" asp-route-id="@employee.Id">
                        <button type="submit" class="btn btn-danger">Delete</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
}

<script>
    document.addEventListener("DOMContentLoaded", function () {
        var toastEl = document.querySelector(".toast");
        var toast = new bootstrap.Toast(toastEl, { delay: 5000 }); // Auto-hide after 5 seconds
        toast.show();
    });
</script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    $(document).ready(function () {
        $("#searchInput").on("input", function () {
            let searchValue = $(this).val().trim();

            if (searchValue.length < 2) { // Evita ricerche troppo brevi
                location.reload(); // Ricarica l'elenco originale se il campo è vuoto
                return;
             }

            $.ajax({
                url: "/Employee/SearchEmployees",
                type: "GET",
                data: { searchValue: searchValue },
                success: function (response) {
                    let tbody = $("#employeeTableBody");
                    tbody.empty();

                    if (response.results.length > 0) {
                        response.results.forEach(function (employee) {
                            let departmentName = "No Department"; // Placeholder

                            // Trova il nome del dipartimento
                            let matchingDepartment = @Html.Raw(Json.Serialize(Departments))
                                .find(d => d.value === employee.Department);

                            if (matchingDepartment) {
                                departmentName = matchingDepartment.text;
                            }

                            let row = `
                                <tr>
                                    <td>
                                        <img src="/Files/Images/${employee.imagePath ?? 'NotFound.png'}" class="rounded-circle" width="40" height="40" />
                                    </td>
                                    <td>${employee.name}</td>
                                    <td>${employee.email}</td>
                                    <td>${employee.employeeType}</td>
                                    <td>${employee.age}</td>
                                    <td>${employee.salary}</td>
                                    <td>${departmentName}</td>
                                    <td>
                                        <span class="badge ${employee.isActive ? "bg-success" : "bg-danger"}">
                                            ${employee.isActive ? "Yes" : "No"}
                                        </span>
                                    </td>
                                    <td>${employee.gender}</td>
                                    <td class="actions">
                                        <a class="btn btn-sm btn-info" href="/Employee/Details/${employee.id}" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a class="btn btn-sm btn-warning" href="/Employee/Edit/${employee.id}" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal-${employee.id}" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `;

                            tbody.append(row);
                        });
                    } else {
                        tbody.append(`
                            <tr>
                                <td colspan="10" class="text-center text-muted">No results found</td>
                            </tr>
                        `);
                    }
                }
            });
        });
    });
</script>

